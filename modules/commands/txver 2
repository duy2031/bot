module.exports.config = {
  name: "taixiu2",
  version: "1.0.0",
  hasPermssion: 0,
  credits: "DuyVuongUwU (fix by ChatGPT)",
  description: "TÃ i xá»‰u nhÆ°ng nhiá»u ngÆ°á»i chÆ¡i!",
  commandCategory: "Game",
  usages: "[new/leave/start/end]",
  cooldowns: 5
};

module.exports.languages = {
  "vi": {
    "moneyEror": "âš  Sá»‘ tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡!",
    "moneyMin": "âš  Sá»‘ tiá»n cÆ°á»£c pháº£i lá»›n hÆ¡n hoáº·c báº±ng 500Ä‘!",
    "moneyDeCreate": "âš  Báº¡n khÃ´ng Ä‘á»§ %1$ Ä‘á»ƒ táº¡o bÃ n game!",
    "gameCreated": "âš  NhÃ³m nÃ y Ä‘Ã£ cÃ³ bÃ n game!",
    "createSuccess": "ğŸ¥³ ÄÃ£ táº¡o bÃ n chÆ¡i!\nSá»‘ tiá»n cÆ°á»£c: %1$\nHiá»‡n cÃ³ 1 ngÆ°á»i chÆ¡i.\nDÃ¹ng %2 start Ä‘á»ƒ báº¯t Ä‘áº§u, %3 end Ä‘á»ƒ káº¿t thÃºc, %4 join Ä‘á»ƒ tham gia!",
    "notCreatedYet": "âš  NhÃ³m nÃ y chÆ°a cÃ³ bÃ n game!",
    "gameStarted": "âš  BÃ n game nÃ y Ä‘Ã£ báº¯t Ä‘áº§u!",
    "moneyDeJoin": "âš  Báº¡n khÃ´ng Ä‘á»§ %1$ Ä‘á»ƒ tham gia!",
    "joined": "âš  Báº¡n Ä‘Ã£ tham gia bÃ n game!",
    "joinSuccess": "ğŸ¥³ Tham gia thÃ nh cÃ´ng! Hiá»‡n cÃ³ %1 ngÆ°á»i chÆ¡i.",
    "userNotInGame": "âš  Báº¡n khÃ´ng cÃ³ trong bÃ n game!",
    "leaveFail": "âš  BÃ n game Ä‘Ã£ báº¯t Ä‘áº§u, khÃ´ng thá»ƒ rá»i!",
    "leaveSuccess": "ğŸ¥º Báº¡n Ä‘Ã£ rá»i bÃ n game.",
    "countPlayer": "ğŸ¥º %1 Ä‘Ã£ rá»i bÃ n, hiá»‡n cÃ²n %2 ngÆ°á»i.",
    "authorLeave": "ğŸ¥º %1 Ä‘Ã£ rá»i, bÃ n game Ä‘Ã£ giáº£i tÃ¡n!",
    "startFail": "âš  Báº¡n khÃ´ng pháº£i chá»§ bÃ n game!",
    "notEnoughMembers": "âš  KhÃ´ng Ä‘á»§ ngÆ°á»i Ä‘á»ƒ báº¯t Ä‘áº§u!",
    "startPlaying": "ğŸ”Š GAME START: CÃ³ %1 ngÆ°á»i! Nháº¯n 'tÃ i' hoáº·c 'xá»‰u' Ä‘á»ƒ chá»n!",
    "endFail": "âš  Báº¡n khÃ´ng pháº£i chá»§ bÃ n game!",
    "endSuccess": "ğŸ† ÄÃ£ káº¿t thÃºc bÃ n game!",
    "tutorial": "âš  CÃ¡ch dÃ¹ng:\n- create/new/-c: Táº¡o bÃ n\n- join/-j: Tham gia\n- leave/-l: Rá»i bÃ n\n- start/-s: Báº¯t Ä‘áº§u\n- end/-e: Káº¿t thÃºc",
    "error": "âš  Lá»—i module: %1"
  }
};

module.exports.handleEvent = async function ({ api, event, Currencies }) {
  const { threadID, messageID, body, senderID } = event;
  if (!body) return;

  const typ = ["tÃ i", "xá»‰u"];
  const random = typ[Math.floor(Math.random() * typ.length)];
  const gameThread = global.taixiuS?.get(threadID);

  if (!gameThread || !gameThread.start) return;

  if (body.toLowerCase() == "tÃ i" || body.toLowerCase() == "xá»‰u") {
    const player = gameThread.player.find(p => p.userID == senderID);
    if (!player) return;

    if (player.choose.status) {
      return api.sendMessage("âš  Báº¡n Ä‘Ã£ chá»n rá»“i!", threadID, messageID);
    }

    player.choose = { status: true, msg: body.toLowerCase() };
    api.sendMessage(`ğŸ‘¤ ${player.name} Ä‘Ã£ chá»n ${body.toUpperCase()}!`, threadID, messageID);

    const allChosen = gameThread.player.every(p => p.choose.status);
    if (allChosen) {
      api.sendMessage("ğŸ¥³ Äang láº¯c....", threadID, async (err, data) => {
        if (err) return;
        setTimeout(async () => {
          api.unsendMessage(data.messageID);
          const ketqua = random;
          const win = [];
          const lose = [];

          gameThread.player.forEach(p => {
            if (p.choose.msg == ketqua) win.push(p);
            else lose.push(p);
          });

          let msg = `ğŸ’ Káº¾T QUáº¢: ${ketqua.toUpperCase()}\n\nğŸ¥³ NgÆ°á»i tháº¯ng:\n`;
          for (let i = 0; i < win.length; i++) {
            const user = win[i];
            const data = await Currencies.getData(user.userID);
            data.money += gameThread.money * 3;
            await Currencies.setData(user.userID, { data });
            msg += `${i + 1}. ${user.name}\n`;
          }

          if (lose.length > 0) {
            msg += "\nğŸ¥º NgÆ°á»i thua:\n";
            for (let i = 0; i < lose.length; i++) {
              const user = lose[i];
              const data = await Currencies.getData(user.userID);
              data.money -= gameThread.money;
              await Currencies.setData(user.userID, { data });
              msg += `${i + 1}. ${user.name}\n`;
            }
          }

          msg += `\nğŸ Má»—i ngÆ°á»i tháº¯ng nháº­n: ${gameThread.money * 3}$\nğŸ’° Má»—i ngÆ°á»i thua máº¥t: ${gameThread.money}$`;

          global.taixiuS.delete(threadID);
          api.sendMessage(msg, threadID);
        }, 5000);
      });
    }
  }
};

module.exports.run = async function ({ api, event, args, Users, Currencies, getText }) {
  try {
    if (!global.taixiuS) global.taixiuS = new Map();
    const { threadID, messageID, senderID } = event;
    let gameThread = global.taixiuS.get(threadID);

    switch (args[0]) {
      case "create":
      case "new":
      case "-c": {
        if (!args[1] || isNaN(args[1])) return api.sendMessage(getText("moneyEror"), threadID, messageID);
        const money = parseInt(args[1]);
        if (money < 50) return api.sendMessage(getText("moneyMin"), threadID, messageID);

        const userMoney = (await Currencies.getData(senderID)).money || 0;
        if (userMoney < money) return api.sendMessage(getText("moneyDeCreate", money), threadID, messageID);

        if (gameThread) return api.sendMessage(getText("gameCreated"), threadID, messageID);

        const name = await Users.getNameUser(senderID);
        global.taixiuS.set(threadID, {
          box: threadID,
          start: false,
          author: senderID,
          player: [{ name, userID: senderID, choose: { status: false, msg: null } }],
          money
        });
        return api.sendMessage(getText("createSuccess", money, global.config.PREFIX + this.config.name, global.config.PREFIX + this.config.name, global.config.PREFIX + this.config.name), threadID);
      }

      case "join":
      case "-j": {
        if (!gameThread) return api.sendMessage(getText("notCreatedYet"), threadID, messageID);
        if (gameThread.start) return api.sendMessage(getText("gameStarted"), threadID, messageID);

        const userMoney = (await Currencies.getData(senderID)).money || 0;
        if (userMoney < gameThread.money) return api.sendMessage(getText("moneyDeJoin", gameThread.money), threadID, messageID);

        if (gameThread.player.some(p => p.userID == senderID)) return api.sendMessage(getText("joined"), threadID, messageID);

        const name = await Users.getNameUser(senderID);
        gameThread.player.push({ name, userID: senderID, choose: { status: false, msg: null } });
        global.taixiuS.set(threadID, gameThread);
        return api.sendMessage(getText("joinSuccess", gameThread.player.length), threadID, messageID);
      }

      case "leave":
      case "-l": {
        if (!gameThread) return api.sendMessage(getText("notCreatedYet"), threadID, messageID);
        const index = gameThread.player.findIndex(p => p.userID == senderID);
        if (index === -1) return api.sendMessage(getText("userNotInGame"), threadID, messageID);
        if (gameThread.start) return api.sendMessage(getText("leaveFail"), threadID, messageID);

        if (gameThread.author == senderID) {
          global.taixiuS.delete(threadID);
          const name = await Users.getNameUser(senderID);
          return api.sendMessage(getText("authorLeave", name), threadID, messageID);
        } else {
          const name = gameThread.player[index].name;
          gameThread.player.splice(index, 1);
          global.taixiuS.set(threadID, gameThread);
          api.sendMessage(getText("leaveSuccess"), threadID, messageID);
          return api.sendMessage(getText("countPlayer", name, gameThread.player.length), threadID);
        }
      }

      case "start":
      case "-s": {
        if (!gameThread) return api.sendMessage(getText("notCreatedYet"), threadID, messageID);
        if (gameThread.author != senderID) return api.sendMessage(getText("startFail"), threadID, messageID);
        if (gameThread.player.length <= 1) return api.sendMessage(getText("notEnoughMembers"), threadID, messageID);
        if (gameThread.start) return api.sendMessage(getText("gameStarted"), threadID, messageID);

        gameThread.start = true;
        global.taixiuS.set(threadID, gameThread);
        return api.sendMessage(getText("startPlaying", gameThread.player.length), threadID);
      }

      case "end":
      case "-e": {
        if (!gameThread) return api.sendMessage(getText("notCreatedYet"), threadID, messageID);
        if (gameThread.author != senderID) return api.sendMessage(getText("endFail"), threadID, messageID);

        global.taixiuS.delete(threadID);
        return api.sendMessage(getText("endSuccess"), threadID, messageID);
      }

      default:
        return api.sendMessage(getText("tutorial"), threadID, messageID);
    }
  } catch (err) {
    return api.sendMessage(getText("error", err), event.threadID, event.messageID);
  }
};

